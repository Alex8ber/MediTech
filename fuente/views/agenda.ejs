<%- include('header') %>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda</title>
    <link rel="stylesheet" href="../css/estilos3.css">
</head>

<body>
	<div class="main-content">
		 <main>

    <div class="menu">
		<p data-target="#general">General</p>
		<p data-target="#hoy">Hoy</p>
		<p data-target="#semana">Semana</p>
        <p data-target="#mes">Mes</p>
		<div class="line"></div>
	</div>
    
	<div class="content">
		<div data-content id="general" class="active">
			<h1>Agenda General</h1>
			<div class="card-container">
				<div class="card">
					<div class="card-content">
						<h3>Citas</h3>
						<h2><%= totalCitas %> programadas</h2>
						<p>Revisa y gestiona tus citas de hoy.</p>
						<button id="btn-ver-agenda">Ver agenda</button>
					</div>
				</div>
				<div class="card">
					<div class="card-content">
						<h3>Pacientes</h3>
						<h2><%= totalPacientes %> registrados</h2>
						<p>Consulta la lista de pacientes.</p>
						<button id="btn-ver-pacientes">Ver pacientes</button>
					</div>
				</div>
			</div>

			<div class="tabla-section">
				<div class="tabla-titulo">Historial de Citas</div>
				<table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Paciente</th>
                        <th>Revisión</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (todasLasCitas && todasLasCitas.length > 0) { %>
                        <% todasLasCitas.forEach(function(cita) { %>
                            <tr>
                                <td><%= cita.Fecha.toISOString ? cita.Fecha.toISOString().slice(0,10) : cita.Fecha.slice(0,10) %></td>
                                <td><%= cita.Hora %></td>
                                <td><%= cita.Nombres %> <%= cita.Apellidos %></td>
                                <td><%= cita.Observaciones %></td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="4">No hay citas registradas.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
			</div>

		</div>

		<div data-content id="hoy">
			<h1>Agenda de Hoy</h1>

			<!-- Filtros de búsqueda agregados -->
    <div class="busqueda">
        <div>
            <label for="buscar-hoy-revision">Buscar Revisión</label>
            <input type="text" id="buscar-hoy-revision" placeholder="Buscar revisión">
        </div>
        <div>
            <label for="buscar-hoy-fecha">Buscar Fecha y Hora</label>
            <input type="datetime-local" id="buscar-hoy-fecha">
        </div>
    </div>

			<div class="tabla-section">
				<div class="tabla-titulo">Citas de Hoy</div>
				<table>
					<thead>
						<tr>
							<th>Hora</th>
							<th>Paciente</th>
							<th>Revisión</th>
						</tr>
					</thead>

					<tbody id="tabla-hoy">
						
    <% if (citasHoy && citasHoy.length > 0) { %>
        <% citasHoy.forEach(function(cita) { %>
            <tr>
                <td><%= cita.Hora %></td>
                <td><%= cita.Nombres %> <%= cita.Apellidos %></td>
                <td><%= cita.Observaciones %></td>
            </tr>
        <% }) %>
    <% } else { %>
        <tr>
            <td colspan="3">No hay citas para hoy.</td>
        </tr>
    <% } %>
</tbody>
				</table>
			</div>
		</div>

		<div data-content id="semana">
			<h1>Agenda de la Semana</h1>
    <div class="busqueda">
        <div>
            <label for="buscar-semana-revision">Buscar Revisión</label>
            <input type="text" id="buscar-semana-revision" placeholder="Buscar revisión">
        </div>
        <div>
            <label for="buscar-semana-fecha">Buscar Fecha y Hora</label>
            <input type="datetime-local" id="buscar-semana-fecha">
        </div>
    </div>

			<div class="tabla-section">
				<div class="tabla-titulo">Citas de Hoy</div>
				<table>
					<thead>
						<tr>
							<th>Hora</th>
							<th>Paciente</th>
							<th>Revisión</th>
							<th>Fecha</th>
						</tr>
					</thead>

					<tbody id="tabla-semana">
    <% if (citasSemana && citasSemana.length > 0) { %>
        <% citasSemana.forEach(function(cita) { %>
            <tr>
                <td><%= cita.Hora %></td>
                <td><%= cita.Nombres %> <%= cita.Apellidos %></td>
                <td><%= cita.Observaciones %></td>
                <td><%= cita.Fecha.toISOString ? cita.Fecha.toISOString().slice(0,10) : cita.Fecha.slice(0,10) %></td>
            </tr>
        <% }) %>
    <% } else { %>
        <tr>
            <td colspan="4">No hay citas para esta semana.</td>
        </tr>
    <% } %>
</tbody>
				</table>
			</div>
		</div>

        <div data-content id="mes">
			<h1>Agenda del Mes</h1>

			<div class="busqueda">
            <div>
                <label for="buscar-mes-revision">Buscar Revisión</label>
                <input type="text" id="buscar-mes-revision" placeholder="Buscar revisión">
            </div>
            <div>
                <label for="buscar-mes-fecha">Buscar Fecha y Hora</label>
                <input type="datetime-local" id="buscar-mes-fecha">
            </div>
        	</div>

			<div class="tabla-section">
				<div class="tabla-titulo">Citas de Hoy</div>
				<table>
					<thead>
						<tr>
							<th>Hora</th>
							<th>Paciente</th>
							<th>Revisión</th>
							<th>Fecha</th>
						</tr>
					</thead>

					<tbody id="tabla-mes">
    <% if (citasMes && citasMes.length > 0) { %>
        <% citasMes.forEach(function(cita) { %>
            <tr>
                <td><%= cita.Hora %></td>
                <td><%= cita.Nombres %> <%= cita.Apellidos %></td>
                <td><%= cita.Observaciones %></td>
                <td><%= cita.Fecha.toISOString ? cita.Fecha.toISOString().slice(0,10) : cita.Fecha.slice(0,10) %></td>
            </tr>
        <% }) %>
    <% } else { %>
        <tr>
            <td colspan="4">No hay citas para este mes.</td>
        </tr>
    <% } %>
</tbody>
				</table>
			</div>
		</div>
    </div>
	</div>

    </main>
	<script>
		const targets = document.querySelectorAll('[data-target]')
		const content = document.querySelectorAll('[data-content]')

		targets.forEach(target => {
		target.addEventListener('click', (e) => {
		content.forEach(c => {
			c.classList.remove('active')
		})
		const t = document.querySelector(target.dataset.target)
		t.classList.add('active')

		var line = document.querySelector('.line');
		line.style.width = e.target.offsetWidth + "px";
		line.style.left = e.target.offsetLeft + "px";
		})

		
	})
	</script>

	<script>
        document.getElementById('buscar').addEventListener('input', function() {
            const filtro = this.value.toLowerCase();
            const filas = document.querySelectorAll('#tabla-agenda tr');
            filas.forEach(fila => {
                const textoFila = fila.textContent.toLowerCase();
                fila.style.display = textoFila.includes(filtro) ? '' : 'none';
            });
        });
    </script>

    <script>
    // Filtro para la tabla de "Hoy"
    const buscarHoyRevision = document.getElementById('buscar-hoy-revision');
    const buscarHoyFecha = document.getElementById('buscar-hoy-fecha');
    const filasHoy = document.querySelectorAll('#tabla-hoy tr');

    function filtrarTablaHoy() {
        const filtroRevision = buscarHoyRevision.value.toLowerCase();
        const filtroFechaHora = buscarHoyFecha.value; // formato: "YYYY-MM-DDTHH:MM"
        let filtroHora = '';
        if (filtroFechaHora) {
            const partes = filtroFechaHora.split('T');
            filtroHora = partes[1] ? partes[1].slice(0,5) : ''; // Solo HH:MM
        }

        filasHoy.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            const horaFila = fila.querySelector('td:nth-child(1)') ? fila.querySelector('td:nth-child(1)').textContent.trim().slice(0,5) : '';
            const coincideRevision = textoFila.includes(filtroRevision);
            let coincideHora = true;
            if (filtroHora) {
                coincideHora = horaFila === filtroHora;
            }
            if (coincideRevision && coincideHora) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    }

    buscarHoyRevision.addEventListener('input', filtrarTablaHoy);
    buscarHoyFecha.addEventListener('input', filtrarTablaHoy);

    // Filtro para la tabla de "Semana"
    const buscarSemanaRevision = document.getElementById('buscar-semana-revision');
    const buscarSemanaFecha = document.getElementById('buscar-semana-fecha');
    const filasSemana = document.querySelectorAll('#tabla-semana tr');

    function filtrarTablaSemana() {
        const filtroRevision = buscarSemanaRevision.value.toLowerCase();
        const filtroFechaHora = buscarSemanaFecha.value; // formato: "YYYY-MM-DDTHH:MM"
        let filtroFecha = '';
        let filtroHora = '';
        if (filtroFechaHora) {
            const partes = filtroFechaHora.split('T');
            filtroFecha = partes[0] || '';
            filtroHora = partes[1] ? partes[1].slice(0,5) : '';
        }

        filasSemana.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            const horaFila = fila.querySelector('td:nth-child(1)') ? fila.querySelector('td:nth-child(1)').textContent.trim().slice(0,5) : '';
            const fechaFila = fila.querySelector('td:nth-child(4)') ? fila.querySelector('td:nth-child(4)').textContent : '';
            const coincideRevision = textoFila.includes(filtroRevision);
            let coincideFechaHora = true;
            if (filtroFechaHora) {
                coincideFechaHora = fechaFila.includes(filtroFecha) && horaFila === filtroHora;
            }
            if (coincideRevision && coincideFechaHora) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    }

    buscarSemanaRevision.addEventListener('input', filtrarTablaSemana);
    buscarSemanaFecha.addEventListener('input', filtrarTablaSemana);

    // Filtro para la tabla de "Mes"
    const buscarMesRevision = document.getElementById('buscar-mes-revision');
    const buscarMesFecha = document.getElementById('buscar-mes-fecha');
    const filasMes = document.querySelectorAll('#tabla-mes tr');

    function filtrarTablaMes() {
        const filtroRevision = buscarMesRevision.value.toLowerCase();
        const filtroFechaHora = buscarMesFecha.value; // formato: "YYYY-MM-DDTHH:MM"
        let filtroFecha = '';
        let filtroHora = '';
        if (filtroFechaHora) {
            const partes = filtroFechaHora.split('T');
            filtroFecha = partes[0] || '';
            filtroHora = partes[1] ? partes[1].slice(0,5) : '';
        }

        filasMes.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            const horaFila = fila.querySelector('td:nth-child(1)') ? fila.querySelector('td:nth-child(1)').textContent.trim().slice(0,5) : '';
            const fechaFila = fila.querySelector('td:nth-child(4)') ? fila.querySelector('td:nth-child(4)').textContent : '';
            const coincideRevision = textoFila.includes(filtroRevision);
            let coincideFechaHora = true;
            if (filtroFechaHora) {
                coincideFechaHora = fechaFila.includes(filtroFecha) && horaFila === filtroHora;
            }
            if (coincideRevision && coincideFechaHora) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    }

    buscarMesRevision.addEventListener('input', filtrarTablaMes);
    buscarMesFecha.addEventListener('input', filtrarTablaMes);
</script>
<script>
document.getElementById('btn-ver-agenda').addEventListener('click', function() {
    document.querySelector('[data-target="#hoy"]').click();
});
</script>
<script>
document.getElementById('btn-ver-pacientes').addEventListener('click', function() {
    window.location.href = '/pacientes';
});
</script>
<!-- ...existing code... -->
<%- include('footer.ejs') %>
</body>
</html>
